global
    maxconn 100000
    log stdout format raw local0

defaults
    mode http
    log global
    option httplog
    timeout connect 10s
    timeout client 60s
    timeout server 60s

frontend http_front
    bind *:8080
    default_backend fastapi_servers

frontend ws_front
    bind *:8081
    default_backend wsproxy_servers

backend fastapi_servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server fastapi1 loadtest-fastapi-1:8000 check inter 5s maxconn 10000
    server fastapi2 loadtest-fastapi-2:8000 check inter 5s maxconn 10000

backend wsproxy_servers
    # Extract session_id from path /{agent_id}/ws/{session_id} and hash on it
    # This ensures same session always goes to same wsproxy instance (sticky)
    # while distributing different sessions across instances
    http-request set-header X-Session-ID %[path,field(4,/)]
    balance hdr(X-Session-ID)
    hash-type consistent
    option httpchk GET /health
    http-check expect status 200
    server wsproxy1 loadtest-wsproxy-1:4040 check inter 5s maxconn 5000
    server wsproxy2 loadtest-wsproxy-2:4040 check inter 5s maxconn 5000
    server wsproxy3 loadtest-wsproxy-3:4040 check inter 5s maxconn 5000

listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
